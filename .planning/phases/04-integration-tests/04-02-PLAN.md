---
phase: 04-integration-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/__tests__/integration/hooks/useLibrary.test.ts
  - src/__tests__/integration/hooks/useSettings.test.ts
autonomous: true

must_haves:
  truths:
    - "useLibrary hook loads library from localStorage on mount"
    - "useLibrary hook persists saved texts to localStorage"
    - "useLibrary hook removes texts and updates localStorage"
    - "useSettings hook loads settings from localStorage on mount"
    - "useSettings hook applies default settings when localStorage empty"
    - "useSettings hook persists updated settings to localStorage"
  artifacts:
    - path: "src/__tests__/integration/hooks/useLibrary.test.ts"
      provides: "Integration tests for useLibrary hook with localStorage mocking"
      min_lines: 80
    - path: "src/__tests__/integration/hooks/useSettings.test.ts"
      provides: "Integration tests for useSettings hook with localStorage mocking"
      min_lines: 80
  key_links:
    - from: "useLibrary.test.ts"
      to: "useLibrary.ts"
      via: "import hook and test through TestComponent"
      pattern: "import.*useLibrary.*from"
    - from: "useSettings.test.ts"
      to: "useSettings.ts"
      via: "import hook and test through TestComponent"
      pattern: "import.*useSettings.*from"
---

<objective>
Create integration tests for persistence hooks (useLibrary and useSettings) verifying localStorage interaction through React component context.

Purpose: Verifies that persistence hooks correctly load data on mount and persist changes to localStorage, using the Storage.prototype spy pattern established in Phase 3.

Output: useLibrary.test.ts and useSettings.test.ts with comprehensive integration tests covering INTG-03 and INTG-04 requirements.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-integration-tests/04-CONTEXT.md
@.planning/phases/04-integration-tests/04-RESEARCH.md
@.planning/phases/03-test-infrastructure-unit-tests/03-03-SUMMARY.md
@src/hooks/useLibrary.ts
@src/hooks/useSettings.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test useLibrary hook with localStorage (INTG-03)</name>
  <files>src/__tests__/integration/hooks/useLibrary.test.ts</files>
  <action>
Create useLibrary integration tests:

1. Import test utilities:
   - render, screen, fireEvent from @testing-library/react
   - vi from vitest
   - useLibrary from @/hooks/useLibrary
   - SavedText from @/types

2. Setup/teardown using Storage.prototype spy pattern:
   ```typescript
   let getItemSpy: ReturnType<typeof vi.spyOn>
   let setItemSpy: ReturnType<typeof vi.spyOn>

   beforeEach(() => {
     getItemSpy = vi.spyOn(Storage.prototype, 'getItem')
     setItemSpy = vi.spyOn(Storage.prototype, 'setItem')
   })

   afterEach(() => {
     getItemSpy.mockRestore()
     setItemSpy.mockRestore()
     localStorage.clear()
   })
   ```

3. Create TestComponent that:
   - Uses useLibrary hook
   - Displays library.length and first item title
   - Has buttons for saveText() and deleteText()

4. Test cases for INTG-03:
   - "loads library from localStorage on mount" - mock getItem with saved library, verify rendered count
   - "renders empty library when localStorage empty" - no mock, verify count is 0
   - "saves new text to library and localStorage" - click save, verify setItem called with new text
   - "adds saved text to beginning of library" - save text, verify it appears first
   - "deletes text from library and localStorage" - save then delete, verify setItem called without deleted item
   - "refreshLibrary() reloads from localStorage" - mock updated data, call refresh, verify new data shown

Use behavior-focused test naming without "should" prefix.
Verify through rendered DOM, not internal hook state.
  </action>
  <verify>
Run tests: `npm test -- src/__tests__/integration/hooks/useLibrary.test.ts`
All tests pass with no console errors.
  </verify>
  <done>
6+ tests covering useLibrary localStorage integration passing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test useSettings hook with localStorage (INTG-04)</name>
  <files>src/__tests__/integration/hooks/useSettings.test.ts</files>
  <action>
Create useSettings integration tests:

1. Import test utilities and Storage.prototype spy pattern (same as useLibrary)

2. Create TestComponent that:
   - Uses useSettings hook
   - Displays current settings values (fontFamily, pivotColor, showPivotHighlight)
   - Has buttons for updateSettings() and resetSettings()
   - Input for changing pivotColor

3. Test cases for INTG-04:
   **Default values:**
   - "applies DEFAULT_SETTINGS when localStorage empty" - verify fontFamily is 'monospace', pivotColor is '#FF0000'
   - "loads saved settings from localStorage on mount" - mock getItem with custom settings, verify rendered

   **Updates:**
   - "updateSettings() merges partial settings" - update only fontFamily, verify other settings unchanged
   - "updateSettings() persists to localStorage" - update setting, verify setItem called with updated value
   - "updateSettings() immediately reflects in rendered output" - update, verify DOM shows new value

   **Reset:**
   - "resetSettings() restores DEFAULT_SETTINGS" - customize, reset, verify defaults shown
   - "resetSettings() persists defaults to localStorage" - reset, verify setItem called with defaults

Use behavior-focused test naming.
Verify settings through rendered DOM text content.
  </action>
  <verify>
Run tests: `npm test -- src/__tests__/integration/hooks/useSettings.test.ts`
All tests pass.
  </verify>
  <done>
7+ tests covering useSettings localStorage integration and default values passing.
  </done>
</task>

</tasks>

<verification>
Run all persistence hook tests:
```bash
npm test -- src/__tests__/integration/hooks/useLibrary.test.ts src/__tests__/integration/hooks/useSettings.test.ts
```

Expected: All tests pass
Expected: Storage.prototype spies capture all localStorage interactions
Expected: No localStorage pollution between tests
</verification>

<success_criteria>
1. useLibrary.test.ts has 6+ passing tests for localStorage persistence
2. useSettings.test.ts has 7+ passing tests for settings management
3. INTG-03 satisfied: useLibrary persists and loads from localStorage
4. INTG-04 satisfied: useSettings handles defaults and updates correctly
5. Storage.prototype spy pattern used consistently (matches Phase 3 pattern)
6. No test isolation issues (localStorage cleared between tests)
</success_criteria>

<output>
After completion, create `.planning/phases/04-integration-tests/04-02-SUMMARY.md`
</output>
