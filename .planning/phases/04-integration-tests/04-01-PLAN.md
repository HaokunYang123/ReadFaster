---
phase: 04-integration-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/__tests__/integration/integration-utils.ts
  - src/__tests__/integration/hooks/useRSVP.test.ts
autonomous: true

must_haves:
  truths:
    - "useRSVP hook starts playback when start() called with text"
    - "useRSVP hook pauses and rewinds when pause() called"
    - "useRSVP hook resets to initial state when reset() called"
    - "useRSVP hook advances word index at correct intervals with fake timers"
    - "useRSVP hook marks isComplete when reaching end of words"
  artifacts:
    - path: "src/__tests__/integration/integration-utils.ts"
      provides: "Custom render wrapper and test setup helpers"
      min_lines: 30
    - path: "src/__tests__/integration/hooks/useRSVP.test.ts"
      provides: "Integration tests for useRSVP hook state transitions and timer behavior"
      min_lines: 150
  key_links:
    - from: "useRSVP.test.ts"
      to: "useRSVP.ts"
      via: "import hook and test through TestComponent"
      pattern: "import.*useRSVP.*from"
---

<objective>
Create integration test infrastructure and comprehensive tests for the useRSVP hook covering playback state transitions and timer-based word advancement.

Purpose: Establishes the integration testing foundation and verifies the core RSVP playback hook works correctly with fake timers, state management, and all control functions.

Output: integration-utils.ts with test helpers, useRSVP.test.ts with 15+ integration tests covering INTG-01 and INTG-02 requirements.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-integration-tests/04-CONTEXT.md
@.planning/phases/04-integration-tests/04-RESEARCH.md
@.planning/phases/03-test-infrastructure-unit-tests/03-01-SUMMARY.md
@src/hooks/useRSVP.ts
@src/test-utils/setup.ts
@src/test-utils/fixtures.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create integration test utilities</name>
  <files>src/__tests__/integration/integration-utils.ts</files>
  <action>
Create integration test utilities file with:

1. Custom render wrapper function that can accept optional providers (for future extensibility)
2. createTestComponent helper that creates a component using useRSVP hook and exposes state via data-testid attributes:
   - data-testid="status" showing isPlaying/paused/complete
   - data-testid="word" showing currentWord
   - data-testid="index" showing currentIndex
   - data-testid="progress" showing progress
   - Buttons for start, pause, reset, skipForward, skipBackward
   - WPM display

3. Timer lifecycle helpers:
   - setupFakeTimers() - calls vi.useFakeTimers()
   - teardownFakeTimers() - calls vi.runOnlyPendingTimers() then vi.useRealTimers()
   - advanceTimers(ms) - wraps vi.advanceTimersByTime in act() for React updates

4. Re-export commonly used RTL utilities (render, screen, fireEvent, act) for convenience

Use TypeScript with proper type imports from @testing-library/react and vitest.
  </action>
  <verify>
File exists at src/__tests__/integration/integration-utils.ts with exported utilities.
TypeScript compiles without errors: `npx tsc --noEmit src/__tests__/integration/integration-utils.ts`
  </verify>
  <done>
integration-utils.ts created with custom render, TestComponent, timer helpers, and RTL re-exports.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test useRSVP playback with fake timers (INTG-01)</name>
  <files>src/__tests__/integration/hooks/useRSVP.test.ts</files>
  <action>
Create useRSVP integration tests focusing on timer-based playback behavior:

1. Import from integration-utils.ts and fixtures.ts

2. Setup/teardown:
   - beforeEach: setupFakeTimers()
   - afterEach: teardownFakeTimers()

3. Test cases for INTG-01 (fake timer playback):
   - "advances to next word after interval elapses" - start with "hello world", advance timer by wpmToInterval(300), verify word changed to "world"
   - "continues advancing through all words" - start with 3 words, advance multiple intervals, verify each word displays
   - "marks isComplete when reaching last word" - advance past all words, verify isComplete is true
   - "stops interval when playback completes" - verify no further state changes after completion
   - "respects WPM setting for interval timing" - start at 600 WPM (100ms), verify faster advancement

Use act() wrapper for all timer advancements per RESEARCH.md pattern.
Verify state via rendered DOM text content, not internal state inspection.
  </action>
  <verify>
Run tests: `npm test -- src/__tests__/integration/hooks/useRSVP.test.ts`
All timer-related tests pass.
  </verify>
  <done>
5+ tests covering useRSVP timer-based playback with fake timers passing.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test useRSVP state transitions (INTG-02)</name>
  <files>src/__tests__/integration/hooks/useRSVP.test.ts</files>
  <action>
Add state transition tests to useRSVP.test.ts:

1. Test cases for INTG-02 (play/pause/reset transitions):

   **Start behavior:**
   - "start() tokenizes text and sets first word" - verify currentWord shows first word after start
   - "start() sets isPlaying to true" - verify status shows "playing"
   - "start() with empty text does not start playback" - verify isPlaying remains false
   - "start() after completion restarts from beginning" - complete playback, start again, verify index is 0

   **Pause behavior:**
   - "pause() sets isPlaying to false" - verify status shows "paused"
   - "pause() rewinds by REWIND_AMOUNT (5 words)" - start with 10+ words, advance to word 7, pause, verify index is 2 (7-5)
   - "pause() does not rewind past index 0" - pause at word 3, verify index is 0 (not negative)

   **Reset behavior:**
   - "reset() clears all state" - start, advance, reset, verify words empty, index 0, isPlaying false
   - "reset() stops active playback" - start, reset while playing, verify interval stopped

   **Skip behavior:**
   - "skipForward() advances by SKIP_AMOUNT (10 words)" - verify index increases by 10
   - "skipBackward() decreases by SKIP_AMOUNT (10 words)" - verify index decreases by 10
   - "skipBackward() does not go below 0" - skip backward from word 5, verify index is 0

All tests use behavior-focused naming without "should" prefix per CONTEXT.md.
  </action>
  <verify>
Run tests: `npm test -- src/__tests__/integration/hooks/useRSVP.test.ts`
All state transition tests pass.
  </verify>
  <done>
12+ additional tests covering play/pause/reset/skip state transitions passing.
  </done>
</task>

</tasks>

<verification>
Run all integration tests:
```bash
npm test -- src/__tests__/integration/
```

Expected: All tests pass
Expected: No act() warnings about unwrapped updates
Expected: No timer-related deadlocks or timeouts
</verification>

<success_criteria>
1. integration-utils.ts exists with timer helpers and TestComponent
2. useRSVP.test.ts has 15+ passing integration tests
3. INTG-01 satisfied: Timer-based playback tested with fake timers
4. INTG-02 satisfied: All state transitions (start/pause/reset/skip) verified
5. No flaky tests or race conditions
6. Tests run fast (<1s) with fake timers
</success_criteria>

<output>
After completion, create `.planning/phases/04-integration-tests/04-01-SUMMARY.md`
</output>
