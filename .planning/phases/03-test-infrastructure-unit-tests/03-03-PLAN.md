---
phase: 03-test-infrastructure-unit-tests
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/utils/storage.test.ts
autonomous: true

must_haves:
  truths:
    - "saveSession() stores session data to localStorage"
    - "loadSession() retrieves session data from localStorage"
    - "loadSession() returns null for expired sessions (7+ days old)"
    - "Library functions (save, load, remove) work with localStorage mocking"
    - "Settings functions persist and restore RSVPSettings"
    - "generateId() returns unique timestamp-based IDs"
    - "All functions handle localStorage unavailability gracefully"
  artifacts:
    - path: "src/utils/storage.test.ts"
      provides: "Unit tests for all storage utility functions with localStorage mocking"
      min_lines: 100
      exports: []
  key_links:
    - from: "src/utils/storage.test.ts"
      to: "src/utils/storage.ts"
      via: "import"
      pattern: "from.*storage"
---

<objective>
Write comprehensive unit tests for storage utility functions in src/utils/storage.ts with localStorage mocking.

Purpose: Verify all storage utilities work correctly with localStorage, including session persistence, library management, and settings storage as required by UNIT-09.

Output: Co-located test file src/utils/storage.test.ts with full coverage using vi.spyOn(Storage.prototype) pattern.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-test-infrastructure-unit-tests/03-RESEARCH.md
@.planning/phases/03-test-infrastructure-unit-tests/03-01-SUMMARY.md
@src/utils/storage.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test session persistence functions</name>
  <files>src/utils/storage.test.ts</files>
  <action>
Create src/utils/storage.test.ts with localStorage mocking pattern from RESEARCH.md.

**Setup pattern (at top of file):**
```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest'
import { saveSession, loadSession, clearSession, ... } from './storage'
import type { SavedSession } from '@/types'

describe('storage utilities', () => {
  let getItemSpy: ReturnType<typeof vi.spyOn>
  let setItemSpy: ReturnType<typeof vi.spyOn>
  let removeItemSpy: ReturnType<typeof vi.spyOn>

  beforeEach(() => {
    // Spy on Storage.prototype (not localStorage directly - jsdom limitation)
    getItemSpy = vi.spyOn(Storage.prototype, 'getItem')
    setItemSpy = vi.spyOn(Storage.prototype, 'setItem')
    removeItemSpy = vi.spyOn(Storage.prototype, 'removeItem')
  })

  afterEach(() => {
    getItemSpy.mockRestore()
    setItemSpy.mockRestore()
    removeItemSpy.mockRestore()
    localStorage.clear()
  })
  // ... tests
})
```

**describe('session persistence'):**

**saveSession:**
- `it('saves session to localStorage with correct key')` - verify setItem called with 'readfaster_session'
- `it('serializes session object to JSON')` - verify JSON.stringify in call

**loadSession:**
- `it('returns null when no session exists')` - getItemSpy.mockReturnValue(null) -> expect null
- `it('returns parsed session when valid data exists')` - mock valid JSON, verify returned object
- `it('returns null for expired sessions (7+ days old)')` - mock session with old timestamp
- `it('clears expired sessions from storage')` - verify removeItem called for expired
- `it('returns null when JSON parsing fails')` - mock invalid JSON, expect null (graceful failure)

**clearSession:**
- `it('removes session from localStorage')` - verify removeItem called with correct key
  </action>
  <verify>Run `npm test -- storage.test.ts --run` to verify session tests pass</verify>
  <done>Session persistence functions fully tested with localStorage mocking</done>
</task>

<task type="auto">
  <name>Task 2: Test library management functions</name>
  <files>src/utils/storage.test.ts</files>
  <action>
Add tests for library functions to src/utils/storage.test.ts:

**describe('library management'):**

**loadLibrary:**
- `it('returns empty array when no library exists')` - mock null, expect []
- `it('returns parsed library when data exists')` - mock valid JSON array
- `it('returns empty array when JSON parsing fails')` - mock invalid JSON, expect []

**saveToLibrary:**
- `it('adds new text to beginning of library')` - verify unshift behavior
- `it('updates existing text by id')` - mock existing library with matching id
- `it('limits library to 50 items')` - mock 50+ items, verify trim to 50
- `it('preserves other items when adding new')` - verify existing items remain

**removeFromLibrary:**
- `it('removes text with matching id')` - verify filtered result saved
- `it('preserves other items when removing')` - verify non-matching items remain
- `it('handles removing non-existent id gracefully')` - no error thrown

Create mock SavedText objects with realistic data:
```typescript
const mockText: SavedText = {
  id: 'test-123',
  title: 'Test Title',
  content: 'Test content here',
  savedAt: Date.now(),
  lastPosition: 0,
  wordCount: 3
}
```
  </action>
  <verify>Run `npm test -- storage.test.ts --run` to verify library tests pass</verify>
  <done>Library management functions fully tested</done>
</task>

<task type="auto">
  <name>Task 3: Test settings and utility functions</name>
  <files>src/utils/storage.test.ts</files>
  <action>
Add tests for settings and generateId to src/utils/storage.test.ts:

**describe('settings persistence'):**

**saveSettings:**
- `it('saves settings to localStorage with correct key')` - verify 'readfaster_settings' key
- `it('serializes RSVPSettings object')` - verify full settings object saved

**loadSettings:**
- `it('returns DEFAULT_SETTINGS when no settings exist')` - mock null, verify defaults returned
- `it('merges stored settings with defaults')` - mock partial settings, verify merge
- `it('returns defaults when JSON parsing fails')` - mock invalid JSON
- `it('handles missing properties by using defaults')` - mock settings missing some keys

Import DEFAULT_SETTINGS from @/types for comparison:
```typescript
import { DEFAULT_SETTINGS } from '@/types'
```

**describe('generateId'):**
- `it('returns string in expected format')` - verify format: timestamp-random
- `it('generates unique ids on consecutive calls')` - call twice, verify different
- `it('includes timestamp component')` - verify starts with number (Date.now())

**describe('storage unavailability'):**
Test graceful degradation when localStorage is unavailable:
- Mock Storage.prototype.setItem to throw error
- Verify functions don't crash, return safe defaults:
  - saveSession: doesn't throw
  - loadSession: returns null
  - loadLibrary: returns []
  - loadSettings: returns DEFAULT_SETTINGS
  </action>
  <verify>Run `npm test -- storage.test.ts --run` to verify all storage tests pass</verify>
  <done>Settings, generateId, and storage unavailability handling fully tested</done>
</task>

</tasks>

<verification>
1. `npm test -- storage.test.ts --run` passes all tests
2. All storage functions tested: saveSession, loadSession, clearSession, saveToLibrary, loadLibrary, removeFromLibrary, saveSettings, loadSettings, generateId
3. localStorage mocking uses Storage.prototype pattern (not direct localStorage)
4. Graceful degradation tested for storage unavailability
5. Session expiration (7-day) logic tested
</verification>

<success_criteria>
- All storage utility tests pass
- Requirement UNIT-09 satisfied
- localStorage mocking follows RESEARCH.md pattern
- Edge cases tested: expired sessions, invalid JSON, storage unavailable
- Tests properly clean up mocks in afterEach
</success_criteria>

<output>
After completion, create `.planning/phases/03-test-infrastructure-unit-tests/03-03-SUMMARY.md`
</output>
