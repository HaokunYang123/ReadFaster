---
phase: 03-test-infrastructure-unit-tests
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/utils/rsvp.test.ts
autonomous: true

must_haves:
  truths:
    - "tokenize() splits text correctly on various whitespace patterns"
    - "tokenize() handles multi-language text (CJK, RTL, accented, emoji)"
    - "calculatePivotIndex() returns valid indices for all word lengths 0-20+"
    - "calculatePivotIndex() handles Unicode characters without crashing"
    - "wpmToInterval() converts boundary values correctly (100, 1000 WPM)"
    - "splitWordByPivot() returns correct before/pivot/after parts"
    - "Edge cases (empty string, single char, 100+ chars) return safe defaults"
  artifacts:
    - path: "src/utils/rsvp.test.ts"
      provides: "Unit tests for all RSVP utility functions"
      min_lines: 150
      exports: []
  key_links:
    - from: "src/utils/rsvp.test.ts"
      to: "src/utils/rsvp.ts"
      via: "import"
      pattern: "from.*rsvp"
---

<objective>
Write comprehensive unit tests for RSVP utility functions in src/utils/rsvp.ts.

Purpose: Verify all RSVP algorithms work correctly for standard text, multi-language text, and edge cases as required by UNIT-01 through UNIT-08.

Output: Co-located test file src/utils/rsvp.test.ts with full coverage of tokenize, calculatePivotIndex, wpmToInterval, splitWordByPivot, and calculatePivotOffset.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-test-infrastructure-unit-tests/03-RESEARCH.md
@.planning/phases/03-test-infrastructure-unit-tests/03-01-SUMMARY.md
@src/utils/rsvp.ts
@src/test-utils/fixtures.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test tokenize() function</name>
  <files>src/utils/rsvp.test.ts</files>
  <action>
Create src/utils/rsvp.test.ts with tests for tokenize():

**describe('tokenize')** with nested describes:

**describe('whitespace handling')** - UNIT-01:
- `it('returns empty array for empty string')` - expect([])
- `it('returns empty array for whitespace-only string')` - expect([])
- `it('splits on single spaces')` - 'hello world' -> ['hello', 'world']
- `it('handles multiple consecutive spaces')` - 'hello    world' -> ['hello', 'world']
- `it('handles tabs')` - 'hello\tworld' -> ['hello', 'world']
- `it('handles newlines')` - 'hello\nworld' -> ['hello', 'world']
- `it('handles mixed whitespace')` - ' \n\t hello \t\n world \n ' -> ['hello', 'world']
- `it('preserves punctuation attached to words')` - 'hello, world!' -> ['hello,', 'world!']

**describe('multi-language text')** - UNIT-02:
- Import fixtures from '../test-utils/fixtures'
- `it('tokenizes CJK text')` - use CJK_WORDS fixture, verify words split correctly
- `it('tokenizes RTL text')` - use RTL_WORDS fixture
- `it('tokenizes emoji')` - use EMOJI_WORDS fixture
- `it('tokenizes accented characters')` - use ACCENTED_WORDS fixture
- `it('handles mixed language text')` - 'hello æ—¥æœ¬èªž world' -> ['hello', 'æ—¥æœ¬èªž', 'world']

**describe('edge cases')** - UNIT-08 (tokenize part):
- `it('handles single word with no spaces')` - 'hello' -> ['hello']
- `it('handles very long text (10k+ words)')` - generate large text, verify no crash, returns correct count

Use behavior-focused naming (no "should" prefix) per CONTEXT.md decisions.
  </action>
  <verify>Run `npm test -- rsvp.test.ts --run` to verify tokenize tests pass</verify>
  <done>tokenize() tests cover whitespace patterns, multi-language, and edge cases</done>
</task>

<task type="auto">
  <name>Task 2: Test calculatePivotIndex() and wpmToInterval()</name>
  <files>src/utils/rsvp.test.ts</files>
  <action>
Add tests to src/utils/rsvp.test.ts:

**describe('calculatePivotIndex')** with nested describes:

**describe('standard words')** - UNIT-03:
- `it('returns 0 for empty string')` - calculatePivotIndex('') -> 0
- `it('returns 0 for single character')` - 'a' -> 0
- `it('returns 0 for two characters')` - 'ab' -> 0
- `it('returns 1 for three characters')` - 'abc' -> 1
- `it('calculates 35% position for 4+ char words')` - test 'four', 'hello', 'testing', etc.
- `it('handles 10 character word')` - 'abcdefghij' -> Math.floor(10 * 0.35) = 3
- `it('handles 20+ character word')` - verify formula works for long words

**describe('CJK characters')** - UNIT-04:
- `it('calculates pivot for Chinese characters')` - 'æ—¥æœ¬èªž' (3 chars) -> 1
- `it('calculates pivot for Korean characters')` - 'í•œêµ­ì–´' -> verify
- `it('calculates pivot for Japanese hiragana')` - 'ã²ã‚‰ãŒãª' (4 chars) -> verify

**describe('emoji and surrogate pairs')** - UNIT-05:
- `it('documents emoji .length behavior')` - expect('ðŸ‘‹'.length).toBe(2) (surrogate pair)
- `it('returns 0 for single emoji (length=2)')` - 'ðŸ‘‹' -> 0 (triggers length===2 branch)
- `it('handles emoji sequence')` - 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦' has length 11, verify returns valid index
- `it('handles emoji in word context')` - 'hiðŸ‘‹' has length 4, verify

**describe('RTL and accented')** - UNIT-03/04 related:
- `it('handles RTL Arabic text')` - 'Ù…Ø±Ø­Ø¨Ø§' -> valid index in range
- `it('handles accented characters')` - 'cafÃ©' (4 chars) -> 1

**describe('wpmToInterval')** - UNIT-07:
- `it('converts 600 WPM to 100ms')` - wpmToInterval(600) -> 100
- `it('converts 300 WPM to 200ms')` - wpmToInterval(300) -> 200
- `it('converts boundary 100 WPM to 600ms')` - wpmToInterval(100) -> 600
- `it('converts boundary 1000 WPM to 60ms')` - wpmToInterval(1000) -> 60
- `it('handles 1 WPM')` - wpmToInterval(1) -> 60000
  </action>
  <verify>Run `npm test -- rsvp.test.ts --run` to verify all tests pass</verify>
  <done>calculatePivotIndex() and wpmToInterval() fully tested including Unicode edge cases</done>
</task>

<task type="auto">
  <name>Task 3: Test splitWordByPivot() and calculatePivotOffset()</name>
  <files>src/utils/rsvp.test.ts</files>
  <action>
Add tests to src/utils/rsvp.test.ts:

**describe('splitWordByPivot')** - UNIT-06:

**describe('standard words'):**
- `it('splits empty string correctly')` - '' -> { before: '', pivot: '', after: '', pivotIndex: 0 }
- `it('splits single character')` - 'a' -> { before: '', pivot: 'a', after: '', pivotIndex: 0 }
- `it('splits two characters')` - 'ab' -> { before: '', pivot: 'a', after: 'b', pivotIndex: 0 }
- `it('splits three characters')` - 'abc' -> { before: 'a', pivot: 'b', after: 'c', pivotIndex: 1 }
- `it('splits five character word')` - 'hello' -> { before: 'h', pivot: 'e', after: 'llo', pivotIndex: 1 }

**describe('multi-language'):**
- `it('splits CJK word')` - 'æ—¥æœ¬èªž' -> verify correct split
- `it('splits accented word')` - 'cafÃ©' -> verify pivot at index 1
- `it('splits RTL word')` - verify mathematical correctness (visual rendering is Phase 4)

**describe('edge cases')** - UNIT-08 (splitWordByPivot part):
- `it('handles very long word (100+ chars)')` - create 100+ char word, verify no crash
- `it('handles whitespace-only (if passed)')` - ' ' -> verify graceful handling

**describe('calculatePivotOffset'):**
- `it('centers pivot in container')` - containerWidth=200, charWidth=10, pivotIndex=5 -> calculate expected offset
- `it('handles zero pivot index')` - pivotIndex=0, verify offset centers first char
- `it('handles large pivot index')` - verify calculation for long words
- Document the formula in comments: offset = containerCenter - (pivotIndex * charWidth) - (charWidth / 2)
  </action>
  <verify>Run `npm test -- rsvp.test.ts --run` to verify all tests pass</verify>
  <done>splitWordByPivot() and calculatePivotOffset() fully tested across all word types</done>
</task>

</tasks>

<verification>
1. `npm test -- rsvp.test.ts --run` passes all tests
2. Test file covers all 5 functions: tokenize, calculatePivotIndex, wpmToInterval, splitWordByPivot, calculatePivotOffset
3. Multi-language fixtures used from src/test-utils/fixtures.ts
4. Edge cases (empty, single char, 100+ chars) tested for each relevant function
</verification>

<success_criteria>
- All RSVP utility function tests pass
- Requirements UNIT-01 through UNIT-08 satisfied
- Tests use behavior-focused naming (no "should" prefix)
- Tests grouped by function with nested describes
- Unicode test fixtures used for i18n testing
</success_criteria>

<output>
After completion, create `.planning/phases/03-test-infrastructure-unit-tests/03-02-SUMMARY.md`
</output>
