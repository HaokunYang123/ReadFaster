---
phase: 05-e2e-tests-cicd
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - tests/e2e/focus-mode.spec.ts
  - tests/e2e/settings.spec.ts
  - tests/e2e/library.spec.ts
autonomous: true

must_haves:
  truths:
    - "Focus mode activates when reading starts and deactivates on pause/complete"
    - "Click-to-pause works within focus mode overlay"
    - "Settings changes persist across page reload"
    - "Library saves and loads texts correctly across sessions"
  artifacts:
    - path: "tests/e2e/focus-mode.spec.ts"
      provides: "Focus mode behavior E2E tests"
      contains: "test.describe"
    - path: "tests/e2e/settings.spec.ts"
      provides: "Settings persistence E2E tests"
      contains: "page.reload"
    - path: "tests/e2e/library.spec.ts"
      provides: "Library save/load E2E tests"
      contains: "localStorage"
  key_links:
    - from: "tests/e2e/settings.spec.ts"
      to: "tests/e2e/pages/SettingsPage.ts"
      via: "import and instantiation"
      pattern: "new SettingsPage"
---

<objective>
Create E2E tests for focus mode behavior, settings persistence, and library functionality.

Purpose: Validate that focus mode UX works correctly, settings persist across reloads, and library save/load operates as expected.
Output: E2E test files covering E2E-03, E2E-04, E2E-05, E2E-06 requirements.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-e2e-tests-cicd/05-01-SUMMARY.md
@src/app/page.tsx
@src/components/SettingsModal.tsx
@src/components/Library.tsx
@tests/e2e/pages/ReaderPage.ts
@tests/e2e/pages/SettingsPage.ts
@tests/e2e/pages/LibraryPage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create focus mode E2E tests</name>
  <files>tests/e2e/focus-mode.spec.ts</files>
  <action>
    Create focus-mode.spec.ts with test.describe('Focus mode'):

    Test: "focus mode activates when reading starts"
    - Paste text
    - Start reading
    - Expect focus mode overlay to be visible (fixed inset-0 z-40 element)
    - Expect header/controls to have opacity-0 or pointer-events-none
    - Expect word display to be scaled up

    Test: "focus mode deactivates on pause"
    - Start reading (focus mode active)
    - Pause reading (space key or pause action)
    - Expect focus mode overlay to be hidden
    - Expect header/controls to be visible again

    Test: "focus mode deactivates on completion"
    - Use short text, high WPM for fast completion
    - Start reading
    - Wait for completion
    - Expect focus mode overlay to be hidden
    - Expect controls visible for restart

    Test: "click-to-pause works in focus mode" (E2E-04)
    - Start reading (focus mode active)
    - Click on the word display area / focus mode overlay
    - Expect reading to pause (based on ReaderDisplay onPause prop)
    - Expect focus mode to deactivate

    Test: "focus mode works on mobile viewport"
    - Use mobile project (375px viewport)
    - Start reading
    - Verify focus mode overlay covers screen
    - Verify word is readable (appropriate sizing)
    - Click to pause works on mobile

    Focus mode detection:
    - Check for fixed positioning: locator('.fixed.inset-0')
    - Or check for specific class combination: 'bg-dark/95'
    - Word display scaling: check for 'scale-110' or 'scale-125' class
  </action>
  <verify>
    Run `npm run test:e2e tests/e2e/focus-mode.spec.ts` - all tests pass.
    Focus mode behavior consistent across browsers.
  </verify>
  <done>
    Focus mode tested: activation on play, deactivation on pause/complete, click-to-pause.
    E2E-03 and E2E-04 requirements covered.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create settings and library persistence E2E tests</name>
  <files>tests/e2e/settings.spec.ts, tests/e2e/library.spec.ts</files>
  <action>
    Create settings.spec.ts with test.describe('Settings persistence'):

    Test: "settings modal opens and closes"
    - Click settings button (gear icon in header)
    - Expect modal to be visible
    - Click close button or outside modal
    - Expect modal to be hidden

    Test: "pivot color changes persist across reload" (E2E-05)
    - Open settings
    - Change pivot color (select a different color preset)
    - Close settings
    - Reload page
    - Open settings again
    - Expect selected color to still be selected

    Test: "font settings persist across reload"
    - Open settings
    - Change font family, size, and weight
    - Close settings and reload page
    - Open settings
    - Verify all font settings retained

    Test: "reset settings restores defaults"
    - Change multiple settings
    - Click reset button
    - Expect all settings to return to defaults

    localStorage verification:
    - Use page.evaluate() to check localStorage values after changes
    - Use page.evaluate(() => localStorage.getItem('readfaster-settings'))

    Create library.spec.ts with test.describe('Library functionality'):

    Test: "save text to library"
    - Paste text into textarea
    - Open library section
    - Enter title and save
    - Expect text to appear in library list

    Test: "load text from library" (E2E-06)
    - Save a text to library
    - Clear textarea
    - Click on saved text in library
    - Expect textarea to contain the saved text

    Test: "library persists across page reload" (E2E-06)
    - Save text to library
    - Reload page
    - Expect saved text still in library list

    Test: "delete text from library"
    - Save text
    - Click delete button on saved text
    - Expect text removed from library list
    - Reload and verify still deleted

    Note: Library component location in UI - it's above the text input.
    Use LibraryPage POM for interactions.
  </action>
  <verify>
    Run `npm run test:e2e tests/e2e/settings.spec.ts tests/e2e/library.spec.ts` - all pass.
    Persistence verified via page.reload() in tests.
  </verify>
  <done>
    Settings persistence tested: color, font settings, reset.
    Library save/load tested: save, load, persist, delete.
    E2E-05 and E2E-06 requirements covered.
  </done>
</task>

</tasks>

<verification>
1. `npm run test:e2e` passes for focus-mode, settings, library specs
2. Focus mode activates/deactivates correctly
3. Click-to-pause works within focus mode
4. Settings persist across page.reload()
5. Library texts persist across page.reload()
</verification>

<success_criteria>
- Focus mode behavior validated across all scenarios
- Settings persistence confirmed with reload tests
- Library CRUD and persistence verified
- E2E-03, E2E-04, E2E-05, E2E-06 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/05-e2e-tests-cicd/05-03-SUMMARY.md`
</output>
