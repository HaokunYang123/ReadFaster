---
phase: 05-e2e-tests-cicd
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - .github/workflows/test.yml
  - vitest.config.mts
autonomous: true

must_haves:
  truths:
    - "GitHub Actions runs all tests on PR and push to main"
    - "CI blocks merge if any tests fail"
    - "Coverage reaches 75% minimum overall"
    - "Critical paths (rsvp.ts, hooks) reach 90%+ coverage"
  artifacts:
    - path: ".github/workflows/test.yml"
      provides: "CI/CD pipeline configuration"
      contains: "playwright"
    - path: "vitest.config.mts"
      provides: "Coverage threshold configuration"
      contains: "thresholds"
  key_links:
    - from: ".github/workflows/test.yml"
      to: "package.json"
      via: "npm run commands"
      pattern: "npm run test"
---

<objective>
Create GitHub Actions CI/CD pipeline with coverage threshold enforcement.

Purpose: Ensure all tests run automatically on PR/push with quality gates that block merging if tests fail or coverage drops.
Output: CI workflow file and vitest config with coverage thresholds covering INFRA-05, QUAL-01, QUAL-02, QUAL-03.
</objective>

<execution_context>
@/Users/haokunyang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/haokunyang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-e2e-tests-cicd/05-RESEARCH.md
@.planning/phases/05-e2e-tests-cicd/05-02-SUMMARY.md
@.planning/phases/05-e2e-tests-cicd/05-03-SUMMARY.md
@package.json
@vitest.config.mts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions CI/CD workflow</name>
  <files>.github/workflows/test.yml</files>
  <action>
    Create .github/workflows/ directory.

    Create test.yml with:

    ```yaml
    name: Tests

    on:
      push:
        branches: [main]
      pull_request:
        branches: [main]

    jobs:
      unit-integration:
        name: Unit & Integration Tests
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4

          - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
              node-version: 20
              cache: 'npm'

          - name: Install dependencies
            run: npm ci

          - name: Run unit and integration tests with coverage
            run: npm run test:coverage

      e2e:
        name: E2E Tests
        needs: unit-integration
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4

          - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
              node-version: 20
              cache: 'npm'

          - name: Install dependencies
            run: npm ci

          - name: Install Playwright browsers
            run: npx playwright install --with-deps

          - name: Run E2E tests
            run: npm run test:e2e

          - name: Upload Playwright report
            uses: actions/upload-artifact@v4
            if: failure()
            with:
              name: playwright-report
              path: playwright-report/
              retention-days: 7
    ```

    Key design decisions:
    - Sequential jobs: E2E `needs: unit-integration` (runs after unit tests pass)
    - Cache npm dependencies with setup-node cache feature
    - Do NOT cache Playwright browsers (per research, restore time = download time)
    - Upload artifacts only on failure (save storage)
    - Use ubuntu-latest for consistency

    Note: E2E tests require the dev server. The webServer config in playwright.config.ts handles this.
    For CI, the webServer will run `npm run dev` or `npm run build && npm run start`.
    Update playwright.config.ts webServer command to be CI-appropriate if needed.
  </action>
  <verify>
    Check workflow syntax: Create file and push to branch, verify Actions tab shows workflow.
    Or use `act` locally if installed: `act -n` (dry run).
    Verify .github/workflows/test.yml exists with correct structure.
  </verify>
  <done>
    GitHub Actions workflow created with sequential job structure.
    CI runs unit/integration first, then E2E if passing.
    INFRA-05 and QUAL-03 requirements covered.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure coverage thresholds with ratchet effect</name>
  <files>vitest.config.mts</files>
  <action>
    Update vitest.config.mts to add coverage thresholds:

    Add thresholds to the coverage configuration:

    ```typescript
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json-summary'],
      exclude: [
        'node_modules/**',
        'src/test-utils/**',
        '**/*.d.ts',
        '**/*.config.*',
        '**/*.test.ts',
        '**/*.test.tsx',
        '**/*.spec.ts',
        'tests/**',
      ],
      thresholds: {
        // QUAL-01: 75% minimum overall
        lines: 75,
        branches: 70,  // Slightly lower for branches (complex conditionals)
        functions: 75,
        statements: 75,
        // Per-file can be enabled if needed
        // perFile: true,
      },
    },
    ```

    Note on QUAL-02 (90% for critical paths):
    Vitest supports glob patterns for per-file thresholds, but syntax varies.
    The simplest approach: Set global at 75%, rely on existing tests achieving 90%+ for rsvp.ts and hooks.
    Alternative: Add explicit patterns like:
    ```typescript
    '**/rsvp.ts': { lines: 90, branches: 85, functions: 90, statements: 90 },
    '**/use*.ts': { lines: 90, branches: 85, functions: 90, statements: 90 },
    '**/use*.tsx': { lines: 90, branches: 85, functions: 90, statements: 90 },
    ```

    Choose the explicit pattern approach if Vitest version supports it (check docs).
    If not supported, document that QUAL-02 is monitored via coverage report review.

    Add 'json-summary' reporter for potential CI parsing.

    Run `npm run test:coverage` to verify thresholds work and current coverage meets them.
    If current coverage is below 75%, adjust thresholds to current level with plan to increase.
  </action>
  <verify>
    Run `npm run test:coverage` - passes without threshold errors.
    Coverage report shows lines/branches/functions/statements percentages.
    If thresholds not met, test command fails with clear error.
  </verify>
  <done>
    Coverage thresholds configured: 75% overall minimum.
    Critical path thresholds documented or configured.
    QUAL-01 and QUAL-02 requirements addressed.
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/test.yml` exists with correct structure
2. Workflow has sequential jobs (e2e needs unit-integration)
3. `npm run test:coverage` enforces thresholds
4. Coverage meets 75% minimum (or thresholds adjusted to current level with plan)
5. Playwright artifacts uploaded only on failure
</verification>

<success_criteria>
- GitHub Actions workflow runs on PR and push to main
- E2E tests run only after unit/integration tests pass
- Coverage thresholds block failing builds
- All INFRA-05, QUAL-01, QUAL-02, QUAL-03 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/05-e2e-tests-cicd/05-04-SUMMARY.md`
</output>
